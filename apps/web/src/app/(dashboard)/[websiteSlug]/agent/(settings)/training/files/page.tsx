"use client";

import type { KnowledgeResponse } from "@cossistant/types";
import { useMutation, useQuery, useQueryClient } from "@tanstack/react-query";
import { useCallback, useState } from "react";
import {
	AddFileDialog,
	EditFileDialog,
	FileList,
	useFileMutations,
} from "@/components/file-sources";
import { UpgradeModal } from "@/components/plan/upgrade-modal";
import { Button } from "@/components/ui/button";
import Icon from "@/components/ui/icons";
import { PageContent } from "@/components/ui/layout";
import {
	SettingsHeader,
	SettingsPage,
} from "@/components/ui/layout/settings-layout";
import { TooltipOnHover } from "@/components/ui/tooltip";
import { useWebsite } from "@/contexts/website";
import { useTRPC } from "@/lib/trpc/client";

export default function FilesPage() {
	const website = useWebsite();
	const trpc = useTRPC();
	const [showAddDialog, setShowAddDialog] = useState(false);
	const [showUpgradeModal, setShowUpgradeModal] = useState(false);
	const [editingFile, setEditingFile] = useState<KnowledgeResponse | null>(
		null
	);

	// Data is pre-fetched in the layout, so it will be available immediately
	const { data: aiAgent } = useQuery(
		trpc.aiAgent.get.queryOptions({
			websiteSlug: website.slug,
		})
	);

	// Fetch plan info
	const { data: planInfo } = useQuery(
		trpc.plan.getPlanInfo.queryOptions({ websiteSlug: website.slug })
	);

	// Fetch training stats
	const { data: stats } = useQuery(
		trpc.linkSource.getTrainingStats.queryOptions({
			websiteSlug: website.slug,
			aiAgentId: aiAgent?.id ?? null,
		})
	);

	const queryClient = useQueryClient();

	// Fetch training readiness for train action
	const { data: readiness } = useQuery(
		trpc.aiAgent.getTrainingReadiness.queryOptions({
			websiteSlug: website.slug,
		})
	);

	const startTrainingMutation = useMutation(
		trpc.aiAgent.startTraining.mutationOptions({
			onSuccess: () => {
				queryClient.invalidateQueries({
					queryKey: trpc.aiAgent.getTrainingStatus.queryKey({
						websiteSlug: website.slug,
					}),
				});
				queryClient.invalidateQueries({
					queryKey: trpc.aiAgent.getTrainingReadiness.queryKey({
						websiteSlug: website.slug,
					}),
				});
			},
		})
	);

	const handleTrainRequested = useCallback(() => {
		if (!aiAgent?.id) {
			return;
		}
		const isOnCooldown = readiness?.canTrainAt != null;
		if (isOnCooldown) {
			setShowUpgradeModal(true);
			return;
		}
		startTrainingMutation.mutate({
			websiteSlug: website.slug,
			aiAgentId: aiAgent.id,
		});
	}, [aiAgent?.id, readiness?.canTrainAt, startTrainingMutation, website.slug]);

	const isFreePlan = planInfo?.plan.name === "free";

	// Check if user is at file limit
	const isAtFileLimit =
		stats?.planLimitFiles !== null &&
		stats?.articleKnowledgeCount !== undefined &&
		stats.articleKnowledgeCount >= (stats.planLimitFiles ?? 0);

	// Mutations hook
	const {
		handleCreate,
		handleUpload,
		handleUpdate,
		handleDelete,
		handleToggleIncluded,
		isCreating,
		isUploading,
		isUpdating,
		isDeleting,
		isToggling,
	} = useFileMutations({
		websiteSlug: website.slug,
		aiAgentId: aiAgent?.id ?? null,
		onCreateSuccess: () => {
			setShowAddDialog(false);
		},
		onUploadSuccess: () => {
			// Don't close the dialog on upload success so user can upload more files
		},
		onUpdateSuccess: () => {
			setEditingFile(null);
		},
		onTrainRequested: handleTrainRequested,
	});

	const handleAddFile = useCallback(
		async (params: { title: string; markdown: string; summary?: string }) => {
			await handleCreate(params);
		},
		[handleCreate]
	);

	const handleUploadFiles = useCallback(
		async (files: File[]) => {
			for (const file of files) {
				await handleUpload(file);
			}
		},
		[handleUpload]
	);

	const handleEditFile = useCallback(
		async (
			id: string,
			params: { title: string; markdown: string; summary?: string }
		) => {
			await handleUpdate(id, params);
		},
		[handleUpdate]
	);

	return (
		<SettingsPage>
			<SettingsHeader>
				Files
				<div className="flex items-center gap-2 pr-1">
					<TooltipOnHover content="Add File">
						<Button
							aria-label="Add File"
							onClick={() =>
								isAtFileLimit
									? setShowUpgradeModal(true)
									: setShowAddDialog(true)
							}
							size="sm"
							type="button"
							variant="secondary"
						>
							<Icon filledOnHover name="plus" />
							Add File
						</Button>
					</TooltipOnHover>
				</div>
			</SettingsHeader>
			<PageContent className="py-6 pt-20">
				<div className="space-y-6">
					{/* Stats info */}
					{stats && stats.planLimitFiles !== null && (
						<div className="flex items-center justify-between text-sm">
							<p className="text-muted-foreground">
								<span className="font-medium">
									{stats.articleKnowledgeCount}
								</span>{" "}
								/ {stats.planLimitFiles} Files
							</p>
							{isFreePlan && (
								<button
									className="font-medium text-cossistant-orange hover:cursor-pointer hover:underline"
									onClick={() => setShowUpgradeModal(true)}
									type="button"
								>
									Upgrade for unlimited files
								</button>
							)}
						</div>
					)}

					{/* File List */}
					{aiAgent && (
						<FileList
							aiAgentId={aiAgent.id}
							isDeleting={isDeleting}
							isToggling={isToggling}
							onDelete={handleDelete}
							onEdit={setEditingFile}
							onToggleIncluded={handleToggleIncluded}
							websiteSlug={website.slug}
						/>
					)}
				</div>
			</PageContent>

			{/* Add File Dialog */}
			<AddFileDialog
				fileLimit={stats?.planLimitFiles}
				isAtLimit={isAtFileLimit}
				isSubmitting={isCreating}
				isUploading={isUploading}
				onOpenChange={setShowAddDialog}
				onSubmit={handleAddFile}
				onUpgradeClick={() => setShowUpgradeModal(true)}
				onUpload={handleUploadFiles}
				open={showAddDialog}
				websiteSlug={website.slug}
			/>

			{/* Edit File Dialog */}
			<EditFileDialog
				file={editingFile}
				isSubmitting={isUpdating}
				onOpenChange={(open) => !open && setEditingFile(null)}
				onSubmit={handleEditFile}
				open={editingFile !== null}
			/>

			{/* Upgrade Modal */}
			{planInfo && (
				<UpgradeModal
					currentPlan={planInfo.plan}
					highlightedFeatureKey="ai-agent-training-files"
					initialPlanName="hobby"
					onOpenChange={setShowUpgradeModal}
					open={showUpgradeModal}
					websiteSlug={website.slug}
				/>
			)}
		</SettingsPage>
	);
}
