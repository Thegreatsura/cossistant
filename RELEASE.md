# Release Playbook

This guide covers the day‚Äëto‚Äëday release flows for the SDK packages in this repository. Follow the relevant section for the outcome you need.

---

## Prerequisites

- `NPM_ACCESS_TOKEN` GitHub secret must have publish rights to the `@cossistant/*` packages.
- Run all commands with Bun (`bun@1.2.22`) and ensure `bun install` has been executed.
- Keep `changeset` CLI handy via `bun run changeset` (or `bunx changeset`).

---

## 1. Publishing Beta Builds (`0.0.0-beta.<sha>`)

1. Push the branch you want to preview and open/refresh a PR targeting `main`.
2. Apply the `üöÄ autorelease` label to the PR.
3. Wait for the **Release - Beta** workflow to finish:
   - Versions both packages to `0.0.0-beta.<short_sha>`.
   - Publishes `@cossistant/react` and `@cossistant/next` with the `beta` dist-tag.
   - Uploads artifacts for both builds.
4. Once the follow-up **Release - Beta Comment** workflow completes, check the sticky PR comment for install commands:
   ```sh
   bun add @cossistant/react@0.0.0-beta.<sha>
   bun add @cossistant/next@0.0.0-beta.<sha>
   ```
   The comment also lists equivalent `npm install` instructions.
5. The label is removed automatically. Re-apply it after new commits if you need another beta cut.

---

## 2. Creating Ad-Hoc `next` Builds (`0.0.0-next.<sha>`)

Use this when you want a manual prerelease without involving GitHub Actions.

1. Check out the branch you want to publish.
2. Update package versions locally:
   ```sh
   node .github/version-script-next.js
   ```
3. Install to refresh the lockfile (if required):
   ```sh
   bun install
   ```
4. Publish each package under the `next` dist-tag:
   ```sh
   (cd packages/react && bun run pub:next)
   (cd packages/next && bun run pub:next)
   ```
5. Push a commit or revert the version changes depending on whether you want to keep the `next` bump in git history.

> **Tip:** `next` publishing is manual by design‚Äîadd a dedicated workflow if you need to automate it.

---

## 3. Cutting a Stable Release (Triggered by `chore(release)`)

1. Collect changes with Changesets:

   ```sh
   bun run changeset
   ```

   - Select the affected packages (`@cossistant/react`, `@cossistant/next`) and version bump type.
   - Commit the generated `.changeset/*.md` file along with your code.

2. Merge the feature PR into `main`. The **Release - Prepare** workflow runs on every `main` push:
   - Skips if there are no pending changesets.
   - Otherwise runs `node .github/changeset-version.js` to bump versions, updates lockfiles, and opens/updates the `chore(release): version packages` PR.

3. Review the autogenerated PR (diff shows version bumps and changelog updates). Ensure CI passes, then merge it into `main`.

4. On merge, the head commit message matches `chore(release): version packages`, triggering the **Release** workflow:
   - Installs dependencies and builds both packages with Bun.

- Runs Changesets publish (`bun run release`) using `NPM_ACCESS_TOKEN`.
- Generates release notes from commit history and creates GitHub releases for each published package.

5. Confirm the new versions on npm and review the GitHub releases page for the autogenerated notes.

---

## 4. Manual Production Release (Workflow Dispatch)

Need to republish without merging the release PR (e.g., retry a failed publish)?

1. In GitHub ‚Üí Actions ‚Üí **Release**, click ‚ÄúRun workflow‚Äù.
2. Select the `main` branch and trigger.
3. The job performs the same steps as in section 3 (publish + release notes).

---

## Troubleshooting

- **Release PR not opening:** ensure at least one `.changeset/*.md` exists on `main`. If the file is present but the workflow skipped, check the Actions logs for `Release - Prepare`.
- **Publish failing with auth errors:** verify `NPM_ACCESS_TOKEN` is valid and scoped for write access; re-run the job after updating secrets.
- **Beta publish didn‚Äôt run:** make sure the PR is pointed at `main`, the `üöÄ autorelease` label exists, and the workflow completed successfully.
- **Need to cancel a release:** remove the `chore(release)` PR instead of merging it; no publish happens until that PR hits `main`.

Keep this playbook close‚Äîconsistent use of Changesets and the two GitHub Actions workflows keeps beta previews and stable releases predictable. Happy shipping!
