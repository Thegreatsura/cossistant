name: Release - Beta Comment

on:
  workflow_run:
    workflows:
      - Release - Beta
    types:
      - completed

permissions:
  pull-requests: write

jobs:
  comment:
    if: >
      github.repository_owner == 'cossistantcom' &&
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.pull_requests[0].number != null
    runs-on: ubuntu-latest
    steps:
      - name: Resolve metadata
        id: metadata
        uses: actions/github-script@v7
        with:
          script: |
            const runId = context.payload.workflow_run.id;
            const prNumber = context.payload.workflow_run.pull_requests[0].number;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            const artifact = artifacts.data.artifacts.find((item) =>
              item.name.startsWith("npm-package-react@"),
            );

            if (!artifact) {
              core.setFailed("Unable to locate beta artifact to derive version.");
              return;
            }

            const match = artifact.name.match(/^npm-package-react@([^@]+)-pr-(\d+)$/);
            if (!match) {
              core.setFailed(`Unexpected artifact format: ${artifact.name}`);
              return;
            }

            const version = match[1];
            const artifactPr = Number(match[2]);

            if (artifactPr !== prNumber) {
              core.warning(`Artifact PR (${artifactPr}) does not match workflow PR (${prNumber}).`);
            }

            core.setOutput("version", version);
            core.setOutput("pr", prNumber.toString());

      - name: Post sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ steps.metadata.outputs.pr }}
          header: "beta-release"
          message: |
            ### Beta preview published

            ```
            bun add @cossistant/react@${{ steps.metadata.outputs.version }}
            bun add @cossistant/next@${{ steps.metadata.outputs.version }}
            ```

            ```
            npm install @cossistant/react@${{ steps.metadata.outputs.version }} @cossistant/next@${{ steps.metadata.outputs.version }}
            ```

            Packages are published under the `beta` dist-tag. Re-apply `ðŸš€ autorelease` to cut a fresh build after pushing new commits.

      - name: Remove label
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          issue-number: ${{ steps.metadata.outputs.pr }}
          labels: "ðŸš€ autorelease"
